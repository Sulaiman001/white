var list="public",connected=!1,reConnecting=!1,room="",username="",conn=null,p=function(a){console.log(a)},removeTitle=function(){return"Remove item"},strikeTitle=function(){return"Strike out item"},escapeHtml=function(a){return jQuery("<div/>").text(a).html()},saveText=function(a,c){$.getJSON("ajax.php?a=save&id="+a+"&text="+encodeURIComponent(c)+"&list="+encodeURIComponent(list),function(b){null===a?($("#wt-list-item-0").after('<div id="wt-list-item-'+b.id+'" class="wt-list-item" data-id="'+b.id+
'"><p class="wt-list-item-text"><input type="checkbox" data-id="'+b.id+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+b.id+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+b.id+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+b.id+'" title="'+strikeTitle()+'" /> <span id="wt-text-'+b.id+'" class="wt-text" data-id="'+b.id+'">'+escapeHtml(c)+"</span></p></div>"),conn.send(JSON.stringify({a:"message",actiontype:"add",list:list,text:c,
id:b.id})),applyEditItem(b.id),applyRemoveItem(b.id),applyStrikeItem(b.id),applySaveTextOfItem(b.id),applySaveOnEnter(b.id),applyTooltip()):conn.send(JSON.stringify({a:"message",actiontype:"save",list:list,text:c,id:b.id}))})},editing=!1,applyEditItem=function(a){$("#wt-text-"+a).on("click",function(){editing=!0;var a=$(this).data("id"),b=$("#wt-text-"+a).text();$("#wt-list-item-"+a).html('<input class="wt-list-item-input" type="text" id="wt-list-item-input-'+a+'" data-id="'+a+'" placeholder="Enter new item here" />');
$("#wt-list-item-input-"+a).val(b);$("#wt-list-item-input-"+a).focus();applySaveTextOfItem(a);applySaveOnEnter(a);applyTooltip()})},applyRemoveItem=function(a){$("#wt-list-item-chk-done-"+a).on("click",function(){var a=$(this).data("id");$.getJSON("ajax.php?a=delete&id="+a+"&list="+encodeURIComponent(list),function(b){$("#wt-list-item-"+a).remove();conn.send(JSON.stringify({a:"message",actiontype:"remove",list:list,id:a}))})})},applyStrikeItem=function(a){$("#wt-list-item-chk-strike-"+a).on("click",
function(){var a=$(this).data("id"),b=$("#wt-text-"+a),e=!1;b.hasClass("wt-strike")||(e=!0);$.getJSON("ajax.php?a=strike&id="+a+"&strike="+e+"&list="+encodeURIComponent(list),function(k){e?b.addClass("wt-strike"):b.removeClass("wt-strike");conn.send(JSON.stringify({a:"message",actiontype:"strike",list:list,strike:e,id:a}))})})},applySaveTextOfItem=function(a){prevtime=parseInt((new Date).getTime());curval="";t=null;$(document).on("keyup","#wt-list-item-input-"+a,function(){var a=$(this).data("id");
if(0!==a&&(curtime=parseInt((new Date).getTime()),next=prevtime+500,prevtime=curtime,curtime<next)){clearTimeout(t);var b=$("#wt-list-item-input-"+a).val(),b=b.replace(/'/,"\\'");t=setTimeout("saveText('"+a+"', '"+b+"')",500)}})},doApplySaveOnEnter=function(a,c){if(editing||$("#wt-list-item-input-0").is(":focus")){editing=!1;c.preventDefault();var b=a.data("id");console.log("id: "+b);var e=$("#wt-list-item-input-"+b).val();0===b?saveText(null,e):($("#wt-list-item-"+b).html('<p class="wt-list-item-text"><input type="checkbox" data-id="'+
b+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+b+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+b+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+b+'" title="'+strikeTitle()+'" /> <span id="wt-text-'+b+'" class="wt-text" data-id="'+b+'">'+escapeHtml(e)+"</span></p>"),applyEditItem(b),applyRemoveItem(b),applyStrikeItem(b),applySaveTextOfItem(b),applySaveOnEnter(b),applyTooltip(),saveText(b,e));a.val("")}},applySaveOnEnter=
function(a){$("#wt-list-item-input-"+a).keypress(function(a){var b=$(this);b.on("blur",function(){doApplySaveOnEnter(b,a)});13==a.which&&doApplySaveOnEnter(b,a)})},applyTooltip=function(){/iPhone|iPod|iPad|Android|BlackBerry|phone/i.test(navigator.userAgent)||$(".btn-tooltip").tooltip()},init=function(){var a=window.location.hash,a=a.replace(/^#/,""),a=a.split("/");switch(a[1]){case "list":list=a[2];startConnection(list);load(list);break;default:list="public",startConnection(list),load(list)}},load=
function(a){$(".wt-list-item").remove();$("title").text("#"+a);$.getJSON("ajax.php?a=load&list="+encodeURIComponent(a),function(a){var b=0;$.each(a.items,function(a,c){var d=c.id,f=c.text;0===a&&(b=0);var g=c.strike?"wt-strike":"",h=c.strike?'checked="checked"':"";$("#wt-list-item-"+b).after('<div id="wt-list-item-'+d+'" class="wt-list-item" data-id="'+d+'"><p class="wt-list-item-text"><input type="checkbox" data-id="'+d+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+d+'" title="'+
removeTitle()+'" /> <input type="checkbox" data-id="'+d+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+d+'" '+h+' title="'+strikeTitle()+'" /> <span id="wt-text-'+d+'" class="wt-text '+g+'" data-id="'+d+'">'+escapeHtml(f)+"</span></p></div>");applyEditItem(d);applyRemoveItem(d);applyStrikeItem(d);applyTooltip();b=d})})};
function handleMessage(a){console.log("websocket: handleMessage: json: "+a);a=JSON.parse(a);if("message"===a.a&&a.list===list)if(console.log("websocket: You got the right list."),"strike"===a.actiontype){console.log("websocket: Striking item");var c=$("#wt-text-"+a.id);a.strike?c.addClass("wt-strike"):c.removeClass("wt-strike");$("#wt-list-item-chk-strike-"+a.id).prop("checked",a.strike)}else"remove"===a.actiontype?$("#wt-list-item-"+a.id).remove():"add"===a.actiontype?($("#wt-list-item-0").after('<div id="wt-list-item-'+
a.id+'" class="wt-list-item" data-id="'+a.id+'"><p class="wt-list-item-text"><input type="checkbox" data-id="'+a.id+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+a.id+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+a.id+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+a.id+'" title="'+strikeTitle()+'" /> <span id="wt-text-'+a.id+'" class="wt-text" data-id="'+a.id+'">'+a.text+"</span></p></div>"),applyEditItem(a.id),applyRemoveItem(a.id),
applyStrikeItem(a.id),applySaveTextOfItem(a.id),applySaveOnEnter(a.id),applyTooltip()):"save"===a.actiontype&&($("#wt-list-item-"+a.id).html('<p class="wt-list-item-text"><input type="checkbox" data-id="'+a.id+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+a.id+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+a.id+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+a.id+'" title="'+strikeTitle()+'" /> <span id="wt-text-'+a.id+'" class="wt-text" data-id="'+
a.id+'">'+a.text+"</span></p>"),applyEditItem(a.id),applyRemoveItem(a.id),applyStrikeItem(a.id),applySaveTextOfItem(a.id),applySaveOnEnter(a.id),applyTooltip())}function loginToRoom(a,c){console.log("websocket: loginToRoom");try{console.log("websocket: Starting try");var b={a:"login",room:a};console.log("websocket: Trying to login: "+b);conn.send(JSON.stringify(b))}catch(e){}}
function startConnection(a){connected?loginToRoom(a):(conn=new WebSocket(webSocketUrl),console.log("websocket: Just made connection object."),conn.onopen=function(c){console.log("websocket: onopen");connected=!0;reConnecting=!1;loginToRoom(a)},conn.onclose=function(a){console.log("websocket: onclose");connected=!1;reConnecting||reConnect()},conn.onerror=function(a){console.log("websocket: onerror");connected=!1;reConnecting||reConnect()},conn.onmessage=function(a){console.log("websocket: onmessage");
handleMessage(a.data)})}function reConnect(){reConnecting=!0;connected||(init(),setTimeout(reConnect,2E3))}$(document).ready(function(){init();$(window).on("hashchange",function(){init()});$(".wt-list-item-input:first").focus();applySaveTextOfItem(0);applySaveOnEnter(0)});
