var list="public",connected=!1,reConnecting=!1,room="",username="",conn=null,autolinker=new Autolinker({stripPrefix:!1,newWindow:!0}),p=function(a){},removeTitle=function(){return"Remove item"},strikeTitle=function(){return"Strike out item"},escapeHtml=function(a){a=autolinker.link(jQuery("<div/>").text(a).html());a=a.replace(/@&lt;(.*?)&gt;/,'<span class="label label-remind">$1</span>');a=a.replace(/@\((.*?)\)/,'<span class="label label-remind">$1</span>');a=a.replace(/([0-9]{1,2}:[0-9]{1,2} [0-9]{1,2}\/[0-9]{1,2}\/[0-9]{4})/,
'<span class="label label-remind">$1</span>');a=a.replace(/([^\\])?(#[a-zA-Z0-9-_]+)/g,'$1<span class="label label-label">$2</span>');return a=a.replace(/([^\\])?(![0-9]+)/,'$1<span class="label label-priority">$2</span>')},saveText=function(a,c,b){console.log("done: "+b);$.ajax({type:"POST",url:"services/save/"+encodeURIComponent(list)+"/"+a+"/"+b+"/"+encodeURIComponent(getHashVar(3)),data:{text:c},dataType:"json",success:function(b){null===a?($("#wt-list-item-0").after('<div id="wt-list-item-'+
b.id+'" class="wt-list-item" data-id="'+b.id+'"><p class="wt-list-item-text"><input type="checkbox" data-id="'+b.id+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+b.id+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+b.id+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+b.id+'" title="'+strikeTitle()+'" /> <span id="wt-text-'+b.id+'" class="wt-text" data-id="'+b.id+'">'+escapeHtml(c)+"</span></p></div>"),conn.send(JSON.stringify({a:"message",
actiontype:"add",list:list,text:c,id:b.id})),applyEditItem(b.id),applyRemoveItem(b.id),applyStrikeItem(b.id),applySaveTextOfItem(b.id),applySaveOnEnter(b.id),applyTooltip()):conn.send(JSON.stringify({a:"message",actiontype:"save",list:list,text:c,id:b.id}))}})},editing=!1,applyEditItem=function(a){$("#wt-text-"+a).on("click",function(){editing=!0;var a=$(this).data("id"),b=$("#wt-text-"+a).text();$("#wt-list-item-"+a).html('<input class="wt-list-item-input" type="text" id="wt-list-item-input-'+a+
'" data-id="'+a+'" placeholder="Enter new item here" />');$("#wt-list-item-input-"+a).val(b);$("#wt-list-item-input-"+a).focus();applySaveTextOfItem(a);applySaveOnEnter(a);applyTooltip()})},applyRemoveItem=function(a){$("#wt-list-item-chk-done-"+a).on("click",function(){var a=$(this).data("id");$.getJSON("services/delete/"+a+"/"+encodeURIComponent(getHashVar(3)),function(b){$("#wt-list-item-"+a).remove();conn.send(JSON.stringify({a:"message",actiontype:"remove",list:list,id:a}))})})},applyStrikeItem=
function(a){$("#wt-list-item-chk-strike-"+a).on("click",function(){var a=$(this).data("id"),b=$("#wt-text-"+a),e=!1;b.hasClass("wt-strike")||(e=!0);e?b.addClass("wt-strike"):b.removeClass("wt-strike");$.getJSON("services/strike/"+a+"/"+e+"/"+encodeURIComponent(getHashVar(3)),function(b){b=$("#wt-list-item-"+a);e?$(".wt-list-item:last").after(b):0<$(".wt-strike").size()&&$(".wt-strike:first").parent().parent().before(b);conn.send(JSON.stringify({a:"message",actiontype:"strike",list:list,strike:e,id:a}))}).fail(function(){e?
b.removeClass("wt-strike"):b.addClass("wt-strike")})})},applySaveTextOfItem=function(a){prevtime=parseInt((new Date).getTime());curval="";t=null;$(document).on("keyup","#wt-list-item-input-"+a,function(){var a=$(this).data("id");if(0!==a&&(curtime=parseInt((new Date).getTime()),next=prevtime+500,prevtime=curtime,curtime<next)){clearTimeout(t);var b=$("#wt-list-item-input-"+a).val(),b=b.replace(/'/,"\\'");t=setTimeout("saveText('"+a+"', '"+b+"', 'false')",500)}})},doApplySaveOnEnter=function(a,c){if(editing||
$("#wt-list-item-input-0").is(":focus")){editing=!1;c.preventDefault();var b=a.data("id"),e=$("#wt-list-item-input-"+b).val();0===b?saveText(null,e,!0):($("#wt-list-item-"+b).html('<p class="wt-list-item-text"><input type="checkbox" data-id="'+b+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+b+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+b+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+b+'" title="'+strikeTitle()+'" /> <span id="wt-text-'+
b+'" class="wt-text" data-id="'+b+'">'+escapeHtml(e)+"</span></p>"),applyEditItem(b),applyRemoveItem(b),applyStrikeItem(b),applySaveTextOfItem(b),applySaveOnEnter(b),applyTooltip(),saveText(b,e,!0));a.val("")}},applySaveOnEnter=function(a){$("#wt-list-item-input-"+a).keypress(function(a){var b=$(this);b.on("blur",function(){doApplySaveOnEnter(b,a)});if(13===a.which||27===a.which)console.log("saving 27"),doApplySaveOnEnter(b,a)})},applyAllListClick=function(){$(".wt-all-list-item").on("click",function(){window.location.hash=
"#/list/"+$(this).data("list")+"/"+getHashVar(2)})},applyTooltip=function(){/iPhone|iPod|iPad|Android|BlackBerry|phone/i.test(navigator.userAgent)||$(".btn-tooltip").tooltip()},init=function(){var a=window.location.hash,a=a.replace(/^#/,""),a=a.split("/");startConnection();switch(a[1]){case "list":list=a[2];load(list);break;case "lists":loadAll();break;default:list="public",load(list)}},isUndefined=function(a){return void 0===a},getHashVar=function(a){return window.location.hash.replace(/^#/,"").split("/")[a]},
loadAll=function(){$("#wt-list-item-0").hide();$(".wt-list-item").remove();$("title").text("all lists");$.getJSON("services/load-all/"+encodeURIComponent(getHashVar(2)),function(a){$.each(a.items,function(a,b){$(".wt-list").append('<div class="wt-all-list-item" data-list="'+escapeHtml(b)+'"><a title="#'+escapeHtml(b)+'" href="#/list/'+escapeHtml(b)+"/"+getHashVar(2)+'">#'+escapeHtml(b)+"</a></div>")});applyAllListClick()})},load=function(a){$("#wt-list-item-0").show();$(".wt-list-item").remove();
$(".wt-all-list-item").remove();$("title").text("#"+a);$.getJSON("services/load/"+encodeURIComponent(a)+"/"+encodeURIComponent(getHashVar(3)),function(a){var b=0;$.each(a.items,function(a,c){var d=c.id,f=c.text;0===a&&(b=0);var g=c.strike?"wt-strike":"",h=c.strike?'checked="checked"':"";$("#wt-list-item-"+b).after('<div id="wt-list-item-'+d+'" class="wt-list-item" data-id="'+d+'"><p class="wt-list-item-text"><input type="checkbox" data-id="'+d+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+
d+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+d+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+d+'" '+h+' title="'+strikeTitle()+'" /> <span id="wt-text-'+d+'" class="wt-text '+g+'" data-id="'+d+'">'+escapeHtml(f)+"</span></p></div>");applyEditItem(d);applyRemoveItem(d);applyStrikeItem(d);applyTooltip();b=d})})},sortByPriority=function(){},handleMessage=function(a){a=JSON.parse(a);if("message"===a.a&&a.list===list)if("strike"===a.actiontype){var c=
$("#wt-text-"+a.id);a.strike?c.addClass("wt-strike"):c.removeClass("wt-strike");$("#wt-list-item-chk-strike-"+a.id).prop("checked",a.strike)}else"remove"===a.actiontype?$("#wt-list-item-"+a.id).remove():"add"===a.actiontype?($("#wt-list-item-0").after('<div id="wt-list-item-'+a.id+'" class="wt-list-item" data-id="'+a.id+'"><p class="wt-list-item-text"><input type="checkbox" data-id="'+a.id+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+a.id+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+
a.id+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+a.id+'" title="'+strikeTitle()+'" /> <span id="wt-text-'+a.id+'" class="wt-text" data-id="'+a.id+'">'+a.text+"</span></p></div>"),applyEditItem(a.id),applyRemoveItem(a.id),applyStrikeItem(a.id),applySaveTextOfItem(a.id),applySaveOnEnter(a.id),applyTooltip()):"save"===a.actiontype&&($("#wt-list-item-"+a.id).html('<p class="wt-list-item-text"><input type="checkbox" data-id="'+a.id+'" class="wt-list-item-chk-done btn-tooltip" id="wt-list-item-chk-done-'+
a.id+'" title="'+removeTitle()+'" /> <input type="checkbox" data-id="'+a.id+'" class="wt-list-item-chk-strike btn-tooltip" id="wt-list-item-chk-strike-'+a.id+'" title="'+strikeTitle()+'" /> <span id="wt-text-'+a.id+'" class="wt-text" data-id="'+a.id+'">'+a.text+"</span></p>"),applyEditItem(a.id),applyRemoveItem(a.id),applyStrikeItem(a.id),applySaveTextOfItem(a.id),applySaveOnEnter(a.id),applyTooltip())},qs=function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");a=(new RegExp("[\\?&]"+a+"=([^&#]*)")).exec(location.search);
return null===a?"":decodeURIComponent(a[1].replace(/\+/g," "))},startConnection=function(){connected||(conn=new WebSocket(webSocketUrl),conn.onopen=function(a){connected=!0;reConnecting=!1},conn.onclose=function(a){connected=!1;reConnecting||reConnect()},conn.onerror=function(a){connected=!1;reConnecting||reConnect()},conn.onmessage=function(a){handleMessage(a.data)})},reConnect=function(){reConnecting=!0;connected||(init(),setTimeout(reConnect,2E3))};
$(document).ready(function(){init();$(window).on("hashchange",function(){init()});$(".wt-list-item-input:first").focus();applySaveTextOfItem(0);applySaveOnEnter(0)});
